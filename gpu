#!/bin/bash

echo "====================================================================================================="
printf "%-3s | %-18s | %-12s | %-18s | %-4s | %-15s | %-4s | %-4s | %-4s\n" "GPU" "Slot" "Bus-Id" "Model" "NUMA" "PCIe(Cur/Max)" "T(C)" "F(%)" "U(%)"
echo "-----------------------------------------------------------------------------------------------------"

dmi_info=$(dmidecode -t 9)

nvidia-smi --query-gpu=index,pci.bus_id,name,temperature.gpu,fan.speed,utilization.gpu,pcie.link.gen.current,pcie.link.width.current,pcie.link.gen.max,pcie.link.width.max --format=csv,noheader | while IFS=',' read -r index bus_id name temp fan util pcie_g_cur pcie_w_cur pcie_g_max pcie_w_max; do
    index=$(echo "$index" | xargs)
    bus_id=$(echo "$bus_id" | xargs | tr '[:upper:]' '[:lower:]')
    
    # 모델명 다이어트
    name=$(echo "$name" | xargs | sed -e 's/NVIDIA //g' -e 's/GeForce //g' -e 's/ Server Edition//g' -e 's/ Blackwe.*//g')
    name=${name:0:18}
    
    temp=$(echo "$temp" | xargs)
    
    fan=$(echo "$fan" | xargs | tr -d ' %[]')
    if [[ "$fan" == "NotSupported" || "$fan" == "N/A" || -z "$fan" ]]; then
        fan="N/A"
    fi
    
    util=$(echo "$util" | xargs | tr -d ' %[]')
    if [[ -z "$util" || "$util" == "N/A" ]]; then
        util="N/A"
    fi
    
    pcie_g_cur=$(echo "$pcie_g_cur" | xargs)
    pcie_w_cur=$(echo "$pcie_w_cur" | xargs)
    pcie_g_max=$(echo "$pcie_g_max" | xargs)
    pcie_w_max=$(echo "$pcie_w_max" | xargs)
    
    if [[ -z "$pcie_g_cur" || "$pcie_g_cur" == "[Not Supported]" ]]; then
        pcie_bw="N/A"
    else
        pcie_bw="G${pcie_g_cur}(${pcie_g_max}) x${pcie_w_cur}(${pcie_w_max})"
    fi
    
    # [버그 수정 완료] 시스템 조회용(sys_bus_id)과 화면 출력용(display_bus_id)을 분리
    sys_bus_id=$(echo "$bus_id" | sed 's/^00000000:/0000:/')
    display_bus_id=$(echo "$bus_id" | sed 's/^00000000://')
    
    # NUMA Node 확인 (시스템 조회용 주소 사용)
    numa_file="/sys/bus/pci/devices/${sys_bus_id}/numa_node"
    numa="N/A"
    if [ -f "$numa_file" ]; then
        numa_val=$(cat "$numa_file")
        if [ "$numa_val" != "-1" ]; then
            numa="$numa_val"
        fi
    fi

    slot=""
    current_dev="$sys_bus_id"
    
    while [ -n "$current_dev" ]; do
        dmi_slot=$(echo "$dmi_info" | awk -v bus="$current_dev" '
            /Designation:/ { des=$0; sub(/^[ \t]+Designation: /, "", des) }
            /Bus Address:/ {
                addr=$NF
                if (tolower(addr) == tolower(bus) || tolower(addr) ~ tolower(bus)) {
                    print des
                }
            }
        ' | head -n 1)
        
        if [ -n "$dmi_slot" ]; then
            slot="$dmi_slot"
            break
        fi
        
        dev_path="/sys/bus/pci/devices/$current_dev"
        if [ -e "$dev_path/.." ]; then
            parent_dev=$(basename $(readlink -f "$dev_path/.."))
            if [[ ! "$parent_dev" =~ ^[0-9a-fA-F]{4}:[0-9a-fA-F]{2}:[0-9a-fA-F]{2}\.[0-9a-fA-F]$ ]]; then
                break
            fi
            current_dev="$parent_dev"
        else
            break
        fi
    done

    if [ -z "$slot" ]; then
        for addr_file in /sys/bus/pci/slots/*/address; do
            if [ -f "$addr_file" ]; then
                slot_addr=$(cat "$addr_file")
                if [[ "$sys_bus_id" == *"$slot_addr"* ]]; then
                    found_slot=$(basename $(dirname "$addr_file"))
                    if [[ ! "$found_slot" == 255-* ]]; then
                        slot="V-Slot $found_slot"
                        break
                    fi
                fi
            fi
        done
    fi
    
    if [ -z "$slot" ]; then
        fallback_slot=$((index + 1))
        slot="PCIE$fallback_slot (Idx)"
    fi

    # 화면에 찍을 때는 display_bus_id 출력
    printf "%-3s | %-18s | %-12s | %-18s | %-4s | %-15s | %-4s | %-4s | %-4s\n" "$index" "$slot" "$display_bus_id" "$name" "$numa" "$pcie_bw" "$temp" "$fan" "$util"
done
echo "====================================================================================================="
