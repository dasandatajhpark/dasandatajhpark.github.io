#!/bin/bash

echo "======================================================================================"
printf "%-5s | %-20s | %-25s | %-20s\n" "GPU" "Physical Slot Name" "GPU Name" "Bus-Id"
echo "--------------------------------------------------------------------------------------"

nvidia-smi --query-gpu=index,pci.bus_id,name --format=csv,noheader | while IFS=',' read -r index bus_id name; do
    index=$(echo "$index" | xargs)
    bus_id=$(echo "$bus_id" | xargs | tr '[:upper:]' '[:lower:]')
    name=$(echo "$name" | xargs)
    short_bus_id=$(echo "$bus_id" | sed 's/^00000000:/0000:/')
    
    slot=""

    # 1순위: dmidecode를 이용해 메인보드에 등록된 '물리적 슬롯 이름' 추출 (root 권한 필요)
    if command -v dmidecode &> /dev/null; then
        dmi_slot=$(dmidecode -t 9 2>/dev/null | awk -v bus="$short_bus_id" '
            /Designation:/ { des=$0; sub(/^[ \t]+Designation: /, "", des) }
            /Bus Address:/ && $0 ~ bus { print des }
        ' | head -n 1)
        
        if [ -n "$dmi_slot" ]; then
            slot="$dmi_slot"
        fi
    fi

    # 2순위: dmidecode로 못 찾았거나 권한이 없을 경우 기존 sysfs 방식 사용 (255-1 등)
    if [ -z "$slot" ]; then
        for addr_file in /sys/bus/pci/slots/*/address; do
            if [ -f "$addr_file" ]; then
                slot_addr=$(cat "$addr_file")
                if [[ "$short_bus_id" == *"$slot_addr"* ]]; then
                    slot=$(basename $(dirname "$addr_file"))
                    break
                fi
            fi
        done
    fi
    
    # 3순위: 그래도 없으면 예외 처리
    if [ -z "$slot" ]; then
        slot="N/A (BIOS/HGX 확인)"
    fi

    printf "%-5s | %-20s | %-25s | %-20s\n" "$index" "$slot" "$name" "$bus_id"
done
echo "======================================================================================"
